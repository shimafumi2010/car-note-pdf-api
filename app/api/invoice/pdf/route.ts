typescript import { NextRequest, NextResponse } from 'next/server'; import chromium from '@sparticuz/chromium'; import playwright from 'playwright-core'; export const runtime = 'nodejs'; export const maxDuration = 60; // Vercel Proの場合は60秒まで可能 interface InvoiceData { invoiceId: string; date: string; // ISO format planName: string; amount: number; companyName: string; companyAddress: string; companyPhone: string; billingCycle: 'monthly' | 'yearly'; } /** 請求書HTMLを生成 */ function generateInvoiceHTML(data: InvoiceData): string { const invoiceDate = new Date(data.date); const billingMonth = invoiceDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' }); const nextPaymentDate = new Date(invoiceDate); nextPaymentDate.setMonth(nextPaymentDate.getMonth() + 1); const taxAmount = Math.floor(data.amount / 11); return ` <!DOCTYPE html> <html lang="ja"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>請求明細書 - ${data.invoiceId}</title> <style> @page { size: A4; margin: 20mm; } { margin: 0; padding: 0; box-sizing: border-box; } body { font-family: 'Noto Sans JP', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', sans-serif; font-size: 14px; line-height: 1.6; color: #000; background: white; padding: 0; margin: 0; } .invoice-container { max-width: 800px; margin: 0 auto; background: white; padding: 40px; } .header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #e5e7eb; padding-bottom: 24px; margin-bottom: 32px; } .header-left h1 { font-size: 28px; font-weight: bold; margin-bottom: 12px; } .header-left .meta { font-size: 13px; color: #4b5563; } .header-left .meta p { margin-bottom: 4px; } .header-right { text-align: right; } .header-right .company-name { font-size: 16px; font-weight: bold; margin-bottom: 8px; } .header-right .company-info { font-size: 12px; color: #4b5563; } .header-right .company-info p { margin-bottom: 2px; } .bill-to { margin-bottom: 32px; } .bill-to h3 { font-size: 12px; color: #4b5563; margin-bottom: 12px; } .bill-to .customer-name { font-size: 22px; font-weight: bold; margin-bottom: 8px; } .bill-to .customer-info { font-size: 13px; color: #4b5563; } .bill-to .customer-info p { margin-bottom: 2px; } .billing-details { margin-bottom: 32px; } .billing-details h3 { font-size: 16px; font-weight: bold; margin-bottom: 16px; } table { width: 100%; border-collapse: collapse; margin-bottom: 24px; } thead tr { border-bottom: 2px solid #d1d5db; } th { padding: 12px 16px; text-align: left; font-weight: bold; font-size: 13px; } th.center { text-align: center; } th.right { text-align: right; } tbody tr { border-bottom: 1px solid #e5e7eb; } td { padding: 12px 16px; font-size: 13px; } td.center { text-align: center; } td.right { text-align: right; } .item-detail { font-size: 12px; color: #4b5563; margin-left: 8px; } .total-section { display: flex; justify-content: flex-end; margin-bottom: 32px; } .total-box { width: 300px; } .total-row { display: flex; justify-content: space-between; padding: 12px 0; border-top: 2px solid #000; font-size: 18px; font-weight: bold; } .tax-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 13px; color: #4b5563; } .payment-method { border-top: 1px solid #e5e7eb; padding-top: 24px; margin-bottom: 32px; } .payment-method h3 { font-size: 16px; font-weight: bold; margin-bottom: 12px; } .payment-method .info { font-size: 13px; color: #374151; } .payment-method .info p { margin-bottom: 8px; } .payment-method .info .label { color: #4b5563; } .footer { border-top: 1px solid #e5e7eb; padding-top: 16px; text-align: center; font-size: 11px; color: #6b7280; } .footer p { margin-bottom: 4px; } </style> </head> <body> <div class="invoice-container"> <div class="header"> <div class="header-left"> <h1>請求明細書</h1> <div class="meta"> <p>請求書番号: ${data.invoiceId}</p> <p>発行日: ${invoiceDate.toLocaleDateString('ja-JP')}</p> </div> </div> <div class="header-right"> <div class="company-name">A.I.PC合同会社</div> <div class="company-info"> <p>〒930-0961</p> <p>富山県富山市西長江本町7-3</p> <p>TEL：076-482-5027</p> <p>Email：billing@car-note.jp</p> </div> </div> </div> <div class="bill-to"> <h3>請求先</h3> <div class="customer-name">${data.companyName} 御中</div> <div class="customer-info"> <p>${data.companyAddress}</p> <p>TEL: ${data.companyPhone}</p> </div> </div> <div class="billing-details"> <h3>請求内容</h3> <table> <thead> <tr> <th>項目</th> <th class="center">数量</th> <th class="right">単価（税込）</th> <th class="right">金額（税込）</th> </tr> </thead> <tbody> <tr> <td> ${data.planName} ${billingMonth}分 <span class="item-detail">(${data.billingCycle === 'yearly' ? '年払い' : '月払い'})</span> </td> <td class="center">1</td> <td class="right">¥${data.amount.toLocaleString()}</td> <td class="right">¥${data.amount.toLocaleString()}</td> </tr> </tbody> </table> <div class="total-section"> <div class="total-box"> <div class="total-row"> <span>合計金額（税込）</span> <span>¥${data.amount.toLocaleString()}</span> </div> <div class="tax-row"> <span>うち消費税</span> <span>¥${taxAmount.toLocaleString()}</span> </div> </div> </div> </div> <div class="payment-method"> <h3>お支払い方法</h3> <div class="info"> <p>ご登録のクレジットカードより自動引き落としされます。</p> <p><span class="label">次回引き落とし予定日：</span>${nextPaymentDate.toLocaleDateString('ja-JP')}</p> </div> </div> <div class="footer"> <p>この請求書は自動生成されたものです。</p> <p>お問い合わせ: billing@car-note.jp</p> </div> </div> </body> </html> `; } export async function POST(request: NextRequest) { try { const body = await request.json() as InvoiceData; // バリデーション if (!body.invoiceId || !body.date || !body.planName || !body.amount) { return NextResponse.json( { error: 'Missing required fields' }, { status: 400 } ); } console.log('Generating PDF for invoice:', body.invoiceId); // HTMLを生成 const html = generateInvoiceHTML(body); // Playwrightでブラウザを起動 const browser = await playwright.chromium.launch({ args: chromium.args, executablePath: await chromium.executablePath(), headless: true, }); const page = await browser.newPage(); // HTMLをロード await page.setContent(html, { waitUntil: 'networkidle' }); // PDFを生成 const pdf = await page.pdf({ format: 'A4', printBackground: true, margin: { top: '20mm', right: '20mm', bottom: '20mm', left: '20mm', }, }); await browser.close(); console.log('PDF generated successfully, size:', pdf.length); // ファイル名を生成 const fileName = `invoice_${body.invoiceId}_${new Date().toISOString().split('T')[0]}.pdf`; // PDFを返す return new NextResponse(pdf, { headers: { 'Content-Type': 'application/pdf', 'Content-Disposition': `attachment; filename="${fileName}"`, 'Content-Length': pdf.length.toString(), }, }); } catch (error) { console.error('PDF generation error:', error); return NextResponse.json( { error: 'Failed to generate PDF', details: error instanceof Error ? error.message : String(error) }, { status: 500 } ); } }